<HTML>
<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<!-- Created on May, 24  2001 by texi2html 1.64 -->
<!-- 
Written by: Lionel Cons <Lionel.Cons@cern.ch> (original author)
            Karl Berry  <karl@freefriends.org>
            Olaf Bachmann <obachman@mathematik.uni-kl.de>
            and many others.
Maintained by: Olaf Bachmann <obachman@mathematik.uni-kl.de>
Send bugs and suggestions to <texi2html@mathematik.uni-kl.de>
 
-->
<HEAD>
<TITLE>Autoconf, Automake, and Libtool: Beginnings of a configure.in for Small Project</TITLE>

<META NAME="description" CONTENT="Autoconf, Automake, and Libtool: Beginnings of a configure.in for Small Project">
<META NAME="keywords" CONTENT="Autoconf, Automake, and Libtool: Beginnings of a configure.in for Small Project">
<META NAME="resource-type" CONTENT="document">
<META NAME="distribution" CONTENT="global">
<META NAME="Generator" CONTENT="texi2html 1.64">
<script language="Javascript">
<!--    
// Check the browser version.

    function checkVersion() {
      if (navigator.appVersion.charAt(0)>=3) return true;
      if (navigator.appVersion.charAt(0)>=4) return true;
      else return false;
    }

      if (checkVersion()) {
             homeon = new Image();
             homeon.src = "homeon.png";

             homeoff = new Image();
             homeoff.src = "home.png";

             tocon = new Image();
             tocon.src = "tocon.png";

             tocoff = new Image();
             tocoff.src = "toc.png";

             indexon = new Image();
             indexon.src = "indexon.png";

             indexoff = new Image();
             indexoff.src = "index.png";

             helpon = new Image();
             helpon.src = "helpon.png";

             helpoff = new Image();
             helpoff.src = "help.png";

             backon = new Image();
             backon.src = "backon.png";

             backoff = new Image();
             backoff.src = "back.png";

             forwardon = new Image();
             forwardon.src = "forwardon.png";

             forwardoff = new Image();
             forwardoff.src = "forward.png";

             prevon = new Image();
             prevon.src = "prevon.png";

             prevoff = new Image();
             prevoff.src = "prev.png";

             nexton = new Image();
             nexton.src = "nexton.png";

             nextoff = new Image();
             nextoff.src = "next.png";

             upon = new Image();
             upon.src = "upon.png";

             upoff = new Image();
             upoff.src = "up.png";
         }

     function img_act(imgName) {
             if (checkVersion()) {
             imgOn = eval(imgName + "on.src");
             document [imgName].src = imgOn;
             }
     }

     function img_inact(imgName) {
             if (checkVersion()) {
             imgOff = eval(imgName + "off.src");
             document [imgName].src = imgOff;
             }
     }
// -->
</SCRIPT>

</HEAD>

<BODY LANG="EN" BGCOLOR="#FFFFFF" TEXT="#000000" LINK="#6688AA" VLINK="#336688" ALINK="#808080">

<A NAME="SEC62"></A>
<TABLE BORDER=0 CELLPADDING=0 CELLSPACING=10>
<TR VALIGN="TOP">
<TD ALIGN="MIDDLE" WIDTH=50 BGCOLOR="#e6e6e6">
<TABLE CELLPADDING=1 CELLSPACING=1 BORDER=0>
<TR VALIGN="TOP" ALIGN="LEFT">
<TD VALIGN="MIDDLE" ALIGN="LEFT"><A HREF="autobook_61.html#SEC61" onMouseover="img_act('prev')" onMouseout="img_inact('prev')"><IMG SRC="prev.png" BORDER="0" ALT="Back: syntax.c &#38; syntax.h" ALIGN="MIDDLE" NAME="prev"></A></TD>
</TR>
<TR VALIGN="TOP" ALIGN="LEFT">
<TD VALIGN="MIDDLE" ALIGN="LEFT"><A HREF="autobook_63.html#SEC63" onMouseover="img_act('next')" onMouseout="img_inact('next')"><IMG SRC="next.png" BORDER="0" ALT="Forward: A Sample Shell Application" ALIGN="MIDDLE" NAME="next"></A></TD>
</TR>
<TR VALIGN="TOP" ALIGN="LEFT">
<TD VALIGN="MIDDLE" ALIGN="LEFT"> &nbsp; <TR VALIGN="TOP" ALIGN="LEFT">
<TD VALIGN="MIDDLE" ALIGN="LEFT"><A HREF="autobook_63.html#SEC63" onMouseover="img_act('back')" onMouseout="img_inact('back')"><IMG SRC="back.png" BORDER="0" ALT="FastBack: A Sample Shell Application" ALIGN="MIDDLE" NAME="back"></A></TD>
</TR>
<TR VALIGN="TOP" ALIGN="LEFT">
<TD VALIGN="MIDDLE" ALIGN="LEFT"><A HREF="autobook_52.html#SEC52" onMouseover="img_act('up')" onMouseout="img_inact('up')"><IMG SRC="up.png" BORDER="0" ALT="Up: A Simple Shell Builders Library" ALIGN="MIDDLE" NAME="up"></A></TD>
</TR>
<TR VALIGN="TOP" ALIGN="LEFT">
<TD VALIGN="MIDDLE" ALIGN="LEFT"><A HREF="autobook_63.html#SEC63" onMouseover="img_act('forward')" onMouseout="img_inact('forward')"><IMG SRC="forward.png" BORDER="0" ALT="FastForward: A Sample Shell Application" ALIGN="MIDDLE" NAME="forward"></A></TD>
</TR>
<TR VALIGN="TOP" ALIGN="LEFT">
<TD VALIGN="MIDDLE" ALIGN="LEFT"><A HREF="autobook.html#SEC_Top" onMouseover="img_act('home')" onMouseout="img_inact('home')"><IMG SRC="home.png" BORDER="0" ALT="Top: Autoconf, Automake, and Libtool" ALIGN="MIDDLE" NAME="home"></A></TD>
</TR>
<TR VALIGN="TOP" ALIGN="LEFT">
<TD VALIGN="MIDDLE" ALIGN="LEFT"><A HREF="autobook_toc.html#SEC_Contents" onMouseover="img_act('toc')" onMouseout="img_inact('toc')"><IMG SRC="toc.png" BORDER="0" ALT="Contents: Table of Contents" ALIGN="MIDDLE" NAME="toc"></A></TD>
</TR>
<TR VALIGN="TOP" ALIGN="LEFT">
<TD VALIGN="MIDDLE" ALIGN="LEFT"><A HREF="autobook_285.html#SEC285" onMouseover="img_act('index')" onMouseout="img_inact('index')"><IMG SRC="index.png" BORDER="0" ALT="Index: Index" ALIGN="MIDDLE" NAME="index"></A></TD>
</TR>
<TR VALIGN="TOP" ALIGN="LEFT">
<TD VALIGN="MIDDLE" ALIGN="LEFT"><A HREF="autobook_abt.html#SEC_About" onMouseover="img_act('help')" onMouseout="img_inact('help')"><IMG SRC="help.png" BORDER="0" ALT="About: About this document" ALIGN="MIDDLE" NAME="help"></A></TD>
</TR>
</TABLE>
</TD>
<TD ALIGN="LEFT">
<H3> 9.2.3 Beginnings of a <TT>`configure.in'</TT> </H3>
<!--docid::SEC62::-->
<P>

Now that I have some code, I can run <CODE>autoscan</CODE> to generate a
preliminary<BR> <TT>`configure.in'</TT>.  <CODE>autoscan</CODE> will examine all of
the sources in the current directory tree looking for common points of
non-portability, adding macros suitable for detecting the discovered
problems.  <CODE>autoscan</CODE> generates the following in
<TT>`configure.scan'</TT>:
</P><P>

<TABLE width=100%><tr><td>&nbsp;</td><td class=example bgcolor=#6688aa><br><pre># Process this file with autoconf to produce a configure script.
AC_INIT(sic/eval.h)

# Checks for programs.

# Checks for libraries.

# Checks for header files.
AC_HEADER_STDC
AC_CHECK_HEADERS(strings.h unistd.h)

# Checks for typedefs, structures, and compiler characteristics.
AC_C_CONST
AC_TYPE_SIZE_T

# Checks for library functions.
AC_FUNC_VPRINTF
AC_CHECK_FUNCS(strerror)

AC_OUTPUT()
</pre></td></tr></table></P><P>

<BLOCKQUOTE>
Since the generated <TT>`configure.scan'</TT> does not overwrite your
project's <TT>`configure.in'</TT>, it is a good idea to run
<CODE>autoscan</CODE> periodically even in established project source
trees, and compare the two files.  Sometimes <CODE>autoscan</CODE> will
find some portability issue you have overlooked, or weren't aware of.
</BLOCKQUOTE>
<P>

Looking through the documentation for the macros in this
<TT>`configure.scan'</TT>,<BR> <CODE>AC_C_CONST</CODE> and <CODE>AC_TYPE_SIZE_T</CODE> will
take care of themselves (provided I ensure that <TT>`config.h'</TT> is
included into every source file), and <CODE>AC_HEADER_STDC</CODE> and
<CODE>AC_CHECK_HEADERS(unistd.h)</CODE> are already taken care of in
<TT>`common.h'</TT>.
</P><P>

<CODE>autoscan</CODE> is no silver bullet!  Even here in this
simple example, I need to manually add macros to check for the presence
of <TT>`errno.h'</TT>:
</P><P>

<TABLE width=100%><tr><td>&nbsp;</td><td class=example bgcolor=#6688aa><br><pre>AC_CHECK_HEADERS(errno.h strings.h unistd.h)
</pre></td></tr></table></P><P>

I also need to manually add the Autoconf macro for generating
<TT>`config.h'</TT>; a macro to initialise <CODE>automake</CODE> support; and a
macro to check for the presence of <CODE>ranlib</CODE>.  These should go
close to the start of <TT>`configure.in'</TT>:
</P><P>

<TABLE width=100%><tr><td>&nbsp;</td><td class=example bgcolor=#6688aa><br><pre>...
AC_CONFIG_HEADER(config.h)
AM_INIT_AUTOMAKE(sic, 0.5)

AC_PROG_CC
AC_PROG_RANLIB
...
</pre></td></tr></table></P><P>

Recall that the use of <CODE>bzero</CODE> in <A HREF="autobook_55.html#SEC55">9.2.1.2 Memory Management</A> is not
entirely portable.  The trick is to provide a <CODE>bzero</CODE> work-alike,
depending on which functions Autoconf detects, by adding the following
towards the end of <TT>`configure.in'</TT>:
</P><P>

<TABLE width=100%><tr><td>&nbsp;</td><td class=example bgcolor=#6688aa><br><pre>...
AC_CHECK_FUNCS(bzero memset, break)
...
</pre></td></tr></table></P><P>

With the addition of this small snippet of code to <TT>`common.h'</TT>, I
can now make use of <CODE>bzero</CODE> even when linking with a C library
that has no implementation of its own:
</P><P>

<TABLE width=100%><tr><td>&nbsp;</td><td class=example bgcolor=#6688aa><br><pre>#if !HAVE_BZERO &#38;&#38; HAVE_MEMSET
# define bzero(buf, bytes)      ((void) memset (buf, 0, bytes))
#endif

</pre></td></tr></table></P><P>

An interesting macro suggested by <CODE>autoscan</CODE> is
<CODE>AC_CHECK_FUNCS(strerror)</CODE>.  This tells me that I need to provide a
replacement implementation of <CODE>strerror</CODE> for the benefit of
architectures which don't have it in their system libraries.  This is
resolved by providing a file with a fallback implementation for the
named function, and creating a library from it and any others that
<TT>`configure'</TT> discovers to be lacking from the system library on the
target host.
</P><P>

You will recall that <TT>`configure'</TT> is the shell script the end user
of this package will run on their machine to test that it has all the
features the package wants to use.  The library that is created will
allow the rest of the project to be written in the knowledge that any
functions required by the project but missing from the installers system
libraries will be available nonetheless.  GNU <TT>`libiberty'</TT>
comes to the rescue again -- it already has an implementation of
<TT>`strerror.c'</TT> that I was able to use with a little modification.
</P><P>

Being able to supply a simple implementation of <CODE>strerror</CODE>, as the
<TT>`strerror.c'</TT> file from <TT>`libiberty'</TT> does, relies on there being
a well defined <CODE>sys_errlist</CODE> variable.  It is a fair bet that if
the target host has no <CODE>strerror</CODE> implementation, however, that the
system <CODE>sys_errlist</CODE> will be broken or missing.  I need to write a
configure macro to check whether the system defines <CODE>sys_errlist</CODE>,
and tailor the code in <TT>`strerror.c'</TT> to use this knowledge.
</P><P>

To avoid clutter in the top-level directory, I am a great believer in
keeping as many of the configuration files as possible in their own
sub-directory.   First of all, I will create a new directory called
<SAMP>`config'</SAMP> inside the top-level directory, and put
<TT>`sys_errlist.m4'</TT> inside it:
</P><P>

<TABLE width=100%><tr><td>&nbsp;</td><td class=example bgcolor=#6688aa><br><pre>AC_DEFUN(SIC_VAR_SYS_ERRLIST,
[AC_CACHE_CHECK([for sys_errlist],
sic_cv_var_sys_errlist,
[AC_TRY_LINK([int *p;], [extern int sys_errlist; p = &#38;sys_errlist;],
            sic_cv_var_sys_errlist=yes, sic_cv_var_sys_errlist=no)])
if test x"$sic_cv_var_sys_errlist" = xyes; then
  AC_DEFINE(HAVE_SYS_ERRLIST, 1,
    [Define if your system libraries have a sys_errlist variable.])
fi])

</pre></td></tr></table></P><P>

I must then add a call to this new macro in the <TT>`configure.in'</TT> file
 being careful to put it in the right place --
somwhere between <EM>typedefs and structures</EM> and <EM>library
functions</EM> according to the comments in <TT>`configure.scan'</TT>:
</P><P>

<TABLE width=100%><tr><td>&nbsp;</td><td class=example bgcolor=#6688aa><br><pre>SIC_VAR_SYS_ERRLIST
</pre></td></tr></table></P><P>

GNU Autotools can also be set to store most of their files in a
subdirectory, by calling the <CODE>AC_CONFIG_AUX_DIR</CODE> macro near the top
of <TT>`configure.in'</TT>, preferably right after <CODE>AC_INIT</CODE>:
</P><P>

<TABLE width=100%><tr><td>&nbsp;</td><td class=example bgcolor=#6688aa><br><pre>AC_INIT(sic/eval.c)
AC_CONFIG_AUX_DIR(config)
AM_CONFIG_HEADER(config.h)
...
</pre></td></tr></table></P><P>

Having made this change, many of the files added by running
<CODE>autoconf</CODE> and <CODE>automake --add-missing</CODE> will be put in
the <EM>aux_dir</EM>.
</P><P>

The source tree now looks like this:
</P><P>

<TABLE width=100%><tr><td>&nbsp;</td><td class=example bgcolor=#6688aa><br><pre>sic/
  +-- configure.scan
  +-- config/
  |     +-- sys_errlist.m4
  +-- replace/
  |     +-- strerror.c
  +-- sic/
        +-- builtin.c
        +-- builtin.h
        +-- common.h
        +-- error.c
        +-- error.h
        +-- eval.c
        +-- eval.h
        +-- list.c
        +-- list.h
        +-- sic.c
        +-- sic.h
        +-- syntax.c
        +-- syntax.h
        +-- xmalloc.c
        +-- xstrdup.c
        +-- xstrerror.c
</pre></td></tr></table></P><P>

In order to correctly utilise the fallback implementation, 
<CODE>AC_CHECK_FUNCS(strerror)</CODE> needs to be removed and <CODE>strerror</CODE>
added to <CODE>AC_REPLACE_FUNCS</CODE>:
</P><P>

<TABLE width=100%><tr><td>&nbsp;</td><td class=example bgcolor=#6688aa><br><pre># Checks for library functions.
AC_REPLACE_FUNCS(strerror)
</pre></td></tr></table></P><P>

This will be clearer if you look at the <TT>`Makefile.am'</TT> for the
<TT>`replace'</TT> subdirectory:
</P><P>

<TABLE width=100%><tr><td>&nbsp;</td><td class=example bgcolor=#6688aa><br><pre>## Makefile.am -- Process this file with automake to produce Makefile.in

INCLUDES                =  -I$(top_builddir) -I$(top_srcdir)

noinst_LIBRARIES        = libreplace.a
libreplace_a_SOURCES        = 
libreplace_a_LIBADD        = @LIBOBJS@

</pre></td></tr></table></P><P>

The code tells <CODE>automake</CODE> that I want to build a library for use
within the build tree (i.e. not installed -- <SAMP>`noinst'</SAMP>), and that
has no source files by default.  The clever part here is that when
someone comes to install Sic, they will run <CODE>configure</CODE> which
will test for <CODE>strerror</CODE>, and add <TT>`strerror.o'</TT> to
<CODE>LIBOBJS</CODE> if the target host environment is missing its own
implementation.  Now, when <TT>`configure'</TT> creates
<TT>`replace/Makefile'</TT> (as I asked it to with <CODE>AC_OUTPUT</CODE>),
<SAMP>`@LIBOBJS@'</SAMP> is replaced by the list of objects required on the
installer's machine.
</P><P>

Having done all this at configure time, when my user runs
<CODE>make</CODE>, the files required to replace functions missing
from their target machine will be added to <TT>`libreplace.a'</TT>.
</P><P>

Unfortunately this is not quite enough to start building the project.
First I need to add a top-level <TT>`Makefile.am'</TT> from which to
ultimately create a top-level <TT>`Makefile'</TT> that will descend into
the various subdirectories of the project:
</P><P>

<TABLE width=100%><tr><td>&nbsp;</td><td class=example bgcolor=#6688aa><br><pre>## Makefile.am -- Process this file with automake to produce Makefile.in

SUBDIRS = replace sic
</pre></td></tr></table></P><P>

And <TT>`configure.in'</TT> must be told where it can find instances of
<CODE>Makefile.in</CODE>:
</P><P>

<TABLE width=100%><tr><td>&nbsp;</td><td class=example bgcolor=#6688aa><br><pre>AC_OUTPUT(Makefile replace/Makefile sic/Makefile)
</pre></td></tr></table></P><P>

I have written a <CODE>bootstrap</CODE> script for Sic, for details see
<A HREF="autobook_43.html#SEC43">8. Bootstrapping</A>:
</P><P>

<TABLE width=100%><tr><td>&nbsp;</td><td class=example bgcolor=#6688aa><br><pre>#! /bin/sh

set -x
aclocal -I config
autoheader
automake --foreign --add-missing --copy
autoconf

</pre></td></tr></table></P><P>

The <SAMP>`--foreign'</SAMP> option to <CODE>automake</CODE> tells it to relax
the GNU standards for various files that should be present in a
GNU distribution.  Using this option saves me from havng to create
empty files as we did in <A HREF="autobook_23.html#SEC23">5. A Minimal GNU Autotools Project</A>.
</P><P>

Right.  Let's build the library!  First, I'll run <CODE>bootstrap</CODE>:
</P><P>

<TABLE width=100%><tr><td>&nbsp;</td><td class=example bgcolor=#6688aa><br><pre>$ ./bootstrap
+ aclocal -I config
+ autoheader
+ automake --foreign --add-missing --copy
automake: configure.in: installing config/install-sh
automake: configure.in: installing config/mkinstalldirs
automake: configure.in: installing config/missing
+ autoconf
</pre></td></tr></table></P><P>

The project is now in the same state that an end-user would see, having
unpacked a distribution tarball.  What follows is what an end user might
expect to see when building from that tarball:
</P><P>

<TABLE width=100%><tr><td>&nbsp;</td><td class=example bgcolor=#6688aa><br><pre>$ ./configure
creating cache ./config.cache
checking for a BSD compatible install... /usr/bin/install -c
checking whether build environment is sane... yes
checking whether make sets ${MAKE}... yes
checking for working aclocal... found
checking for working autoconf... found
checking for working automake... found
checking for working autoheader... found
checking for working makeinfo... found
checking for gcc... gcc
checking whether the C compiler (gcc  ) works... yes
checking whether the C compiler (gcc  ) is a cross-compiler... no
checking whether we are using GNU C... yes
checking whether gcc accepts -g... yes
checking for ranlib... ranlib
checking how to run the C preprocessor... gcc -E
checking for ANSI C header files... yes
checking for unistd.h... yes
checking for errno.h... yes
checking for string.h... yes
checking for working const... yes
checking for size_t... yes
checking for strerror... yes
updating cache ./config.cache
creating ./config.status
creating Makefile
creating replace/Makefile
creating sic/Makefile
creating config.h
</pre></td></tr></table></P><P>

Compare this output with the contents of <TT>`configure.in'</TT>, and notice
how each macro is ultimately responsible for one or more consecutive
tests (via the Bourne shell code generated in <TT>`configure'</TT>).  Now
that the <TT>`Makefile'</TT>s have been successfully created, it is safe to
call <CODE>make</CODE> to perform the actual compilation:
</P><P>

<TABLE width=100%><tr><td>&nbsp;</td><td class=example bgcolor=#6688aa><br><pre>$ make
make  all-recursive
make[1]: Entering directory `/tmp/sic'
Making all in replace
make[2]: Entering directory `/tmp/sic/replace'
rm -f libreplace.a
ar cru libreplace.a
ranlib libreplace.a
make[2]: Leaving directory `/tmp/sic/replace'
Making all in sic
make[2]: Entering directory `/tmp/sic/sic'
gcc -DHAVE_CONFIG_H -I. -I. -I.. -I..    -g -O2 -c builtin.c
gcc -DHAVE_CONFIG_H -I. -I. -I.. -I..    -g -O2 -c error.c
gcc -DHAVE_CONFIG_H -I. -I. -I.. -I..    -g -O2 -c eval.c
gcc -DHAVE_CONFIG_H -I. -I. -I.. -I..    -g -O2 -c list.c
gcc -DHAVE_CONFIG_H -I. -I. -I.. -I..    -g -O2 -c sic.c
gcc -DHAVE_CONFIG_H -I. -I. -I.. -I..    -g -O2 -c syntax.c
gcc -DHAVE_CONFIG_H -I. -I. -I.. -I..    -g -O2 -c xmalloc.c
gcc -DHAVE_CONFIG_H -I. -I. -I.. -I..    -g -O2 -c xstrdup.c
gcc -DHAVE_CONFIG_H -I. -I. -I.. -I..    -g -O2 -c xstrerror.c
rm -f libsic.a
ar cru libsic.a builtin.o error.o eval.o list.o sic.o syntax.o xmalloc.o
xstrdup.o xstrerror.o
ranlib libsic.a
make[2]: Leaving directory `/tmp/sic/sic'
make[1]: Leaving directory `/tmp/sic'
</pre></td></tr></table></P><P>

On this machine, as you can see from the output of <CODE>configure</CODE>
above, I have no need of the fallback implementation of <CODE>strerror</CODE>,
so <TT>`libreplace.a'</TT> is empty.  On another machine this might not be
the case.  In any event, I now have a compiled <TT>`libsic.a'</TT> -- so
far, so good.
</P><P>

<A NAME="A Sample Shell Application"></A>
</TR></TABLE>
<BR>  
<FONT SIZE="-1">
This document was generated
by <I>Gary V. Vaughan</I> on <I>May, 24  2001</I>
using <A HREF="http://www.mathematik.uni-kl.de/~obachman/Texi2html
"><I>texi2html</I></A>

</BODY>
</HTML>
