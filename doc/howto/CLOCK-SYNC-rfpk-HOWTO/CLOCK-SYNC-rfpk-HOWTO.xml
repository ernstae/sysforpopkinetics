<?xml version="1.0"?>
<!DOCTYPE article PUBLIC "-//OASIS//DTD DocBook XML V4.2//EN"
[
  <!ENTITY uw "University of Washington">
  <!ENTITY dept "Department of Bioengineering">
]>
<article><title>Clock Synchronization</title>
 <articleinfo>
    <revhistory>
      <revision>
	<revnumber>1.0</revnumber>
	<date>April 25, 2003</date>
	<authorinitials>afw</authorinitials>
	<revremark>Initial version.</revremark>
      </revision>
    </revhistory>
  <abstract>
    <para>
	It is important that the system clocks in the Linux 
	workstations of the RFPK Software Team be closely 
	synchronized with the clock in the Linux server,
	<systemitem moreinfo="none" class="systemname">whitechuck</systemitem>,
	because the CVS application on that machine as well as the
	backup process depends on the comparison of timestamps on
	files residing on different machines.  This tutorial
	explains how to configure your workstation so that it
	stays synchronized within a fraction of a second with that on
 	<systemitem moreinfo="none" class="systemname">whitechuck</systemitem>.
    </para>
  </abstract>
 </articleinfo>
  <sect1>
    <title>Network Time Protocol</title>
    <para>
      The Network Time Protocol (NTP) allows computers connected
      to the Internet to keep their clocks synchronized.  Certain
      host computers equipped with accurate clocks make the NTP
      service available to other, less well endowed, hosts.  
      A machine with an accurate clock which is offering an NTP
      service is known as a <emphasis>level one</emphasis> NTP
      server.  Other machines, which may not be equipped with
      accurate clocks but which nevertheless have accurate time
      due to the fact that they are synchronized to one or more
      <emphasis>level one</emphasis> NTP servers, can offer an
      NTP service over the Internet as <emphasis>level two</emphasis>
      NTP servers, and so on.
    </para>
    <para>
      The host
      <systemitem moreinfo="none" class="systemname">
	bigben.cac.washington.edu
      </systemitem>
      is a <emphasis>level one</emphasis> NTP server equipped
      with a clock that gets its time from GPS satellites. 
      The RFPK Linux server,
      <systemitem moreinfo="none" class="systemname">whitechuck</systemitem>,
      is synchronized to 
      <systemitem moreinfo="none" class="systemname">bigben</systemitem>
      and several other <emphasis>level one</emphasis> NTP servers.
      This document describes the way to configure your 
      RedHat Linux 8.0 workstation to synchronize to 
      <systemitem moreinfo="none" class="systemname">whitechuck</systemitem>.
    </para>
    <para>
      There are two reasons for synchronizing our workstations to
      <systemitem moreinfo="none" class="systemname">whitechuck</systemitem>
      rather than to 
      <systemitem moreinfo="none" class="systemname">bigben</systemitem>:
      <itemizedlist>
	<listitem>
	  <para>
	    Reduce the load on 
	    <systemitem moreinfo="none" class="systemname">bigben</systemitem>.
	  </para>
	</listitem>
	<listitem>
	  <para>
	    Synchronize to the machine that we really want to be 
	    in sync with.  Even if
	    <systemitem moreinfo="none" class="systemname">whitechuck</systemitem>
	    should go out of sync with the <emphasis>level one</emphasis>
	    servers because of Internet problems, for example, our CVS
	    and backup processes would still work well because they would be
	    comparing timestamps on files on our workstations with those on
	    <systemitem moreinfo="none" class="systemname">whitechuck</systemitem>.
	  </para>
	</listitem>
      </itemizedlist>
    </para>
  </sect1>
  <sect1>
    <title>NTP Configuration</title>
    <para>
      In this section, we will edit several configuration files. To do this, 
      you will need root privilege.
    </para>
    <para>
      We will start by putting the file
      <filename moreinfo="none">/etc/ntp.conf</filename> under local
      source control:
      <screen format="linespecific">
su -
cd /etc
ci -l /etc/ntp.conf
      </screen>
      With your favorite editor, set the default behavior to 
      <emphasis>nomodify</emphasis> rather than 
      <emphasis>ignore</emphasis>, which completely disabled the
      NTP service.
      <screen format="linespecific">
restrict default ignore

	<emphasis>should be changed to</emphasis>

restrict default nomodify
      </screen>
      Next specify that 
      <systemitem moreinfo="none" class="systemname">whitechuck</systemitem>
      is our trusted time server by making these changes:
      <screen format="linespecific">
# restrict mytrustedtimeserverip mask 255.255.255.255 nomodify notap noquery
# server mytrustedtimeserverip

	should be changed to

restrict whitechuck mask 255.255.255.255 nomodify notrap noquery
server whitechuck
      </screen>
      Finally set up a dummy time server in case the Internet is down:
      <screen format="linespecific">
server time.nist.gov

	should be replaced by

server 127.127.1.0
      </screen>
</para>
    <para>
      After making the above changes, use the <command moreinfo="none">rcsdiff</command>
      command to check your work:
      <screen format="linespecific">
rcsdiff ntp.conf
      </screen>
    </para>
    <para>
      Finally, we need to make a small change to the 
      <filename moreinfo="none">/etc/ntp/step-tickers</filename> file,
      which is a list of time servers queried by your system when it boots.
    </para>
    <para>
      Still as <systemitem moreinfo="none" class="username">root</systemitem>,
      place <filename moreinfo="none">/etc/step-tickers</filename> under
      source control:
      <screen format="linespecific">
cd /etc/ntp
ci -l step-tickers
      </screen>
      Now we will concatenate the name
      <systemitem moreinfo="none" class="systemname">whitechuck</systemitem>
      to the list of time servers to consulted at start up:
      <screen format="linespecific">
echo whitechuck >> step-tickers
      </screen>
    </para>
  </sect1>
  <sect1>
    <title>Daemon Setup</title>
    <para>
      We need to start the ntp daemon, if it is not already running, and
      make sure that it is started automatically whenever the system reboots.
      As <systemitem moreinfo="none" class="username">root</systemitem>,
      input the following commands:
      <screen format="linespecific">
/etc/rc.d/init.d/ntpd restart
chkconfig --level 2345 ntpd on
      </screen>
    </para>
    <para>
      You should now check that your ntp daemon is working.
      Issue this command:
      <screen format="linespecific">
ntpq -p
      </screen>
      You should see output that looks something like this:
      <screen format="linespecific">
     remote           refid      st t when poll reach   delay   offset  jitter
==============================================================================
 LOCAL(0)        LOCAL(0)        10 l   63   64  377    0.000    0.000   0.008
*whitechuck.rfpk bigben.cac.wash  2 u  192  256  377    0.684    0.075   0.024
      </screen>
    </para>
    <para>
      I believe that this
      shows that there are two time servers, the dummy local server to
      be used in case the network is down, and 
      <systemitem moreinfo="none" class="systemname">whitechuck</systemitem>.
      It shows that 
      <systemitem moreinfo="none" class="systemname">whitechuck</systemitem>
      gets its time from 
      <systemitem moreinfo="none" class="systemname">bigben</systemitem>,
      <systemitem moreinfo="none" class="systemname">whitechuck</systemitem>
      is a level 2 server, it is remote, it was last queried 192 seconds ago,
      it is queried every 256 seconds, a measure of its estimated
      "reachability" is 377, there is a delay of 0.684 milli-seconds
      between the
      time it is queried and the time the response arrives, an offset of 
      0.075 milli-seconds was applied in order to synchronize
      the clocks and an 
      estimate of the random error is 0.024 milli-seconds.
    </para>
    <para>
      If you do not get comparable numbers (for example, the jitter is 0.000)
      there is something wrong. 
    </para>
  </sect1>
</article>

<!--  LocalWords:  afw RFPK whitechuck CVS NTP GPS bigben su cd ci nomodify ntp
 -->
<!--  LocalWords:  mytrustedtimeserverip notap noquery notrap internet rcsdiff
 -->
<!--  LocalWords:  conf chkconfig ntpd ntpq refid rfpk
 -->
